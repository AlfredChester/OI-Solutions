摘要：表达式树，枚举，计数

[传送门：https://www.luogu.com.cn/problem/P7324](https://www.luogu.com.cn/problem/P7324)

## 题意

给定一个由两种二元运算符 `<`、`>`，括号，问号和变量（用 $0 \sim 9$ 的数字表示 $x_0 \sim x_9$）的表达式，其中 $a < b = \min(a, b), a > b = \max(a, b)$，问号表示仍然没有决定填入 `<` 或 `>`。

有 $n$ 组询问，其中给定了 $x_0 \sim x_9$ 的值，试计算整个表达式所有可能的值的和，最后输出所有询问的和。答案对 $10^9 + 7$ 取模。

## 分析思路

我们发现最终表达式的结果一定是 $x_0 \sim x_9$ 中的一个值，这启发我们枚举答案并计算方案数。设最终表达式的答案为 $res$，则一个询问的答案就等于 $\sum res \times cnt_{res}$，其中 $cnt_{res}$ 表示使得答案等于 $res$ 的方案数。于是这题转化为计数题。

而 $\max$ / $\min$ 提示了我们枚举偏序关系。事实上我们如果只关心答案是否小于等于 $res$，我们就可以把大于等于 $res$ 的 $x_i$ 看作 $1$，其他的 $x_i$ 看作 $0$。最后表达式的结果为 $1$ 的方案数乘以 $res$，再进行一些差分操作即可统计答案，于是我们对 $x_0 \sim x_9$ 关于 $res$ 的偏序进行二进制枚举，考虑 dp 计数。

建立表达式树，我们可以进行一个类似于树形 dp 的计数。设 $dp_{i, 0}$ 表示以 $i$ 为根的子树得到 $0$ 的方案数，$dp_{i, 1}$ 表示以 $i$ 为根的子树得到 $1$ 的方案数。记 $i$ 的左儿子为 $l$，右儿子为 $r$。则：

- 若 $i$ 为叶子，则 $dp_{i, val_i} = 1, dp_{i, \sim val_i} = 0$。
- 若 $i$ 对应的是操作符 `<`，则这颗子树的值为 $1$ 当且仅当两边的值都是 $1$，所以 $dp_{i, 1} = dp_{l, 1} \times dp_{r, 1}$，剩余三种情况都会得到 $0$，转移容易写出。
- 若 $i$ 对应的是操作符 `>`，则这颗子树的值为 $0$ 当且仅当两边的值都是 $0$，所以 $dp_{i, 0} = dp_{l, 0} \times dp_{r, 0}$，剩余三种情况都会得到 $1$，转移容易写出。
- 若 $i$ 对应的是操作符 `?`，则这颗子树的值为 $0$ 或 $1$ 的方案数就是操作符为 `<` 和操作符为 `>` 的方案数的和，转移容易写出。

于是我们做到了 $O(T \times |S|)$ 的预处理，其中 $T$ 为总的状态数 $2^{10}$。询问的时候枚举状态，最多只会跳 $9$ 次，差分一下即可得答案。

## 代码

[云剪贴板链接](https://www.luogu.com.cn/paste/rb7fprs0)
