# [NOI2012] 迷失游乐园 题解

摘要：动态规划、期望、树上随机游走、树、基环树

[传送门：https://www.luogu.com.cn/problem/P2081](https://www.luogu.com.cn/problem/P2081)

本蒟蒻写的第一篇黑题题解，也是第一道正儿八经做出来的黑题，纪念一下。

## 题意

给定一棵树或者一棵基环树，从随机一点出发，求每个点**至多经过一次**的路径的期望长度。

## 分析思路

### PART I. 树

首先作如下定义：

$root$ 为该棵树的根节点；

$fa_u$ 表示节点 $u$ 的父亲个数 ( $fa_{root} = 0$ )； 

$son_u$ 为节点 $u$ 的儿子个数；

`上` 为深度较小的方向，`下` 为深度较大的方向。

可以发现，从树上一点 $u$ 出发的路径可以分为两种：一种向下，记其期望长度为 $f_u$；另一种向上，记其期望长度为 $g_u$。

那么从第 $i$ 个点出发的期望路径长度即为：

$$ ans_i = \frac{son_i \times f_i + g_i}{son_i + fa_i} $$

现在来考虑如何求解 $f_u$ 和 $g_u$。

首先容易发现 $f_u$ 不依赖任何的 $g_v$，于是容易得出：

$$
f_u = \frac{1}{son_u} \sum_{v\space\text{is son of}\space u} w_{u, v} + f_v
$$

其中 $w_{u, v}$ 表示 $u, v$ 之间的边权，叶子结点的 $f_u = 0$。

然后我们可以列出 $g_u$ 的递推式，设 $k$ 为 $u$ 的父亲：

$$ g_u = w_{u, k} + \frac{g_k + f_k \times son_k - w_{u, k} - f_u}{son_k + fa_k - 1} $$

其中 $w_{u, v}$ 表示 $u, v$ 之间的边权，根结点的 $g_u = 0$。

对这个式子做出解释：

1. 无论如何长度都加上 $w_{u, k}$。
2. 到达父亲之后，可以选择继续向下走，期望长度（也即所有可能的向上走长度的和）为 $g_k$；也可以选择向下，则所有可能的向下走长度的和为 $f_k \times son_k$。注意不能再走回 $u$，于是总长度减去 $w_{u, k} + f_u$。
3. 总方案数为 $son_k + fa_k - 1$，拿所有可能的长度的和除以方案总数即得到期望长度。

最终答案即为 $\displaystyle \frac{1}{n} \sum_{i=1}^n ans_i$。

### PART II. 基环树

## 代码

```cpp
```
